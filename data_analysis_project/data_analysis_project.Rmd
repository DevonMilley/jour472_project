---
title: "Data Analysis Project"
author: "Devon Milley, Timothy Dashiell, Emmett Gartner"
date: "04/15/2022"
output:
  html_document:
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

In this notebook, we are analyzing this data, The Lasting Legacy Of Redlining.

## Variable explanations
HOLC Grades
One of the principal variables in this dataset is the Home Owners’ Loan Corporation (HOLC) grade. HOLC was a New Deal-era federal agency that collaborated with local banks, cities, and real estate appraisers to rate the “quality” of neighborhoods on a scale of A-D, with ‘A’ being the best and ‘D’ the worst. The variables used to determine these grades included objective indicators like access to amenities, i.e. parks and transportation, and biased variables based on the economic class and race of residents. HOLC grades were then used to determine a homeowner’s qualifications for a mortgage — homeowners in ‘D’ neighborhoods were less likely to receive friendly mortgages and reduced the value of their homes. The long-term impacts of HOLC grades included a drain of wealth from neighborhoods with unfavorable grades.
HOLC grades will be used as a backdrop for the other variables in our dataset. They will show how neighborhoods with poor grades rebounded over the past eight decades and what influence, if any, those grades have on a neighborhood's demographics and median income levels.
Demographic Data
Accompanying the HOLC grades in FiveThirtyEight’s dataset are modern demographic data that show the racial makeup of HOLC neighborhoods and surrounding areas. This includes base-data like total populations, as well as the percentage of a total population each demographic makes up. This will hasten analysis as some of our variables are pre-calculated.

zone-block-matches.csv
The other .csv file in this dataset is the product of FiveThirtyEight journalists matching old HOLC grades/neighborhoods with modern census blocks, then deriving census data and populating census geometry with it.


## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(janitor)
library(lubridate)
library(dplyr)

```

## Load and Cleaning Data

In this section, describe the source of the data, write a basic data dictionary for data you are working with, and discuss any caveats or issues you discovered working with this data.

There are 551 rows and 28 columns in the dataset.

```{r}
# Load required data

metro_grades<-read_csv("data/metro-grades.csv")

zone_block_matches<-st_read("data/zone-block-matches.csv")

```

## Sentences to Engineer
In this notebook, we are reverse engineering five sentences from the story.

### Sentence 1

* **Sentence text**: For each Holc grade, what is the racial composition?
* **Analysis summary**: Our analysis of this question is the most effective of the three, and its findings will be helpful in guiding the rest of our project. To answer it, we grouped by holc_grade then summarised the mean percentage populations of each race in accordance with HOLC letter grades. We found that the majority of neighborhoods that received a HOLC grade of A had a high percent of white people. A grade neighborhoods only had about 8% Black and Hispanic populations each. Lower graded neighborhoods at the C and D level, had higher percents of Black and Hispanic populations, making up about 50% combined for D-level neighborhoods and 41% combined for C-level neighborhoods.  

As we note in the next section, we'd like to try and use this method to see how mean race percentages change from state to state. This will be the start of the geographic analysis we hope to heavily explore.


```{r}
# Put code to reverse engineer sentence here

#we should compare national to regional, national to state ?

holc_grades_race <- metro_grades %>% 
  group_by(holc_grade) %>% 
  summarise(
    pct_white = mean(pct_white),
    pct_black = mean(pct_black),
    pct_hisp = mean(pct_hisp),
    pct_asian = mean(pct_asian),
    pct_other = mean(pct_other))



# Display results of code below this codeblock

```

### Sentence 2

* **Sentence text**: What is the Holc grade breakdown by state? -- need to create a state column
* **Analysis summary**: 

This process made us realize that our dataset aggregates the A, B, C, and D HOLC grades for each city then summarizes the demographic data for each grade. Thus, when we went to summarize HOLC grades by state, we found that the grade counts were consistent across all columns. Our discovery leads us to a new line of inquiry, however. Next week, we can analyze each state's data in a way similar to the process in Sentence 1 and summarize the mean demographic percentages for each state's A, B, C, and D grades.


```{r}
# Put code to reverse engineer sentence here

metro_grades_plus_state <- metro_grades %>% 
  mutate(
    state=str_sub(metro_area, start=-2, end=-1)
  )

holc_by_state <- metro_grades_plus_state %>%
  group_by(state) %>% 
  summarise(
    a_count = sum(holc_grade == "A"),
    b_count = sum(holc_grade == "B"),
    c_count = sum(holc_grade == "C"),
    d_count = sum(holc_grade == "D")
  )
```  
  
  
  summarise( grades = case_when(
   holc_grade == "A" ~ "A",
   holc_grade == "B" ~ "B",
   holc_grade == "C" ~ "C",
   holc_grade == "D" ~ "D")) %>% 
  group_by(grades)

# Display results of code below this codeblock


 Sentence 3

* **Sentence text**: For metro areas with at least 50% of a particular race, how many As, Bs, Cs, Ds are there?
* **Analysis summary**: So, we have pivoted quite a bit from this initial question, and instead tried to determine quartiles of percentages for each race's population share but encountered some difficulties. We then went back to our old method and created a master dataframe that counts the grades when a race's population share is greater than a certain percentage. We went with 5, 10, 15 and 20, because those numbers bring back the most results without excluding any races. Unfortunately, since there are no results for a HOLC grade of "A" when pct_asian is >20%, and I could not figure out how to include the A count anyways, I had to remove that summation — otherwise it would remove the "A" row in the master dataframe.

We also created a diverse neighborhoods dataframe that looked for similar counts, except when all races meet a certain percentage threshold, i.e. >3%, 4%, 5%, etc. I think that this dataframe shows the most promise in this analysis section, but we'd like to figure out a way to bring back more results and perhaps structure a new dataframe that shows combinations of two races greater than a percentage threshold in an effective and concise way.

Overall, what this data reveals is that when larger percentage caps are put on white neighborhoods, such as >15% and >20%, the number of C and D grades decrease while the A and B grades remain relatively constant, where as the opposite is true for black neighborhoods — C and D grades increase while A and B grades decrease substantially.

```{r}
#lets do quartiles of percentages !!!, also consider plurality, not just majority
#Put code to reverse engineer sentence here
#could do something like this but idk why it's not working. may just have to do four tables (filtering on each quartile) for each race and join them together to get what we want. i just feel like there's a more efficient way to do that - Devon

holc_count_white_neighborhoods <- metro_grades %>% 
  mutate(
  white_neighborhoods_count = case_when(
    (pct_white %in% c(0.00:25.00)) == TRUE ~ "0-25% white neighborhood",
    (pct_white %in% c(25.01:50.00)) == TRUE ~ "25-50% white neighborhood",
    (pct_white %in% c(50.01:75.00)) == TRUE ~ "50-75% white neighborhood",
    (pct_white %in% c(75.01:100.00)) == TRUE ~ "75-100% white neighborhood"))
 # group_by(white_neighborhoods_count) %>% 
  #summarise(
   # count = n()
  #)
```

```{r}
#this is blaaaah
q = c(.1, .2, .3, .4)

holc_count_white_neighborhoods <- metro_grades %>% 
  group_by(holc_grade) %>% 
  summarise(
    white_ten = quantile(pct_white, probs=q[1]),
    white_twenty = quantile(pct_white, probs=q[2]),
    white_thirty = quantile(pct_white, probs=q[3]),
    white_forty = quantile(pct_white, probs=q[4])
  )
```




```{r}
#holc grades with pct >20 per race

holc_count_black <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_black > 20) %>% 
  summarise(
    twenty_pct_black_neighborhoods_count = n()
  )

holc_count_hispanic  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_hisp > 20) %>% 
  summarise(
    twenty_pct_hisp_neighborhoods_count = n()
  )


holc_count_white  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_white > 20) %>% 
  summarise(
    twenty_pct_white_neighborhoods_count = n()
  )

holc_grades_twenty <- holc_count_white %>% inner_join(holc_count_black, by=c("holc_grade"))

holc_grades_twenty <-holc_grades_twenty%>%inner_join(holc_count_hispanic, by=c("holc_grade"))

#holc grades with pct >15 per race

holc_count_black <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_black > 15) %>% 
  summarise(
    fifteen_pct_black_neighborhoods_count = n()
  )

holc_count_hispanic  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_hisp > 15) %>% 
  summarise(
    fifteen_pct_hisp_neighborhoods_count = n()
  )

holc_count_asian  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_asian > 15) %>% 
  summarise(
    fifteen_pct_asian_neighborhoods_count = n()
  )

holc_count_white  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_white > 15) %>% 
  summarise(
    fifteen_pct_white_neighborhoods_count = n()
  )

#holc grades with pct >15 per race
holc_grades_fifteen <- holc_count_white %>% inner_join(holc_count_black, by=c("holc_grade"))

holc_grades_fifteen <-holc_grades_fifteen%>%inner_join(holc_count_asian, by=c("holc_grade"))

holc_grades_fifteen <-holc_grades_fifteen%>%inner_join(holc_count_hispanic, by=c("holc_grade"))

holc_grades_pct <- holc_grades_fifteen%>%inner_join(holc_grades_twenty, by=c("holc_grade"))

#holc grades with pct >10 per race

holc_count_black <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_black > 10) %>% 
  summarise(
    ten_pct_black_neighborhoods_count = n()
  )

holc_count_hispanic  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_hisp > 10) %>% 
  summarise(
    ten_pct_hisp_neighborhoods_count = n()
  )

holc_count_asian  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_asian > 10) %>% 
  summarise(
    ten_pct_asian_neighborhoods_count = n()
  )

holc_count_white  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_white > 10) %>% 
  summarise(
    ten_pct_white_neighborhoods_count = n()
  )

holc_grades_ten <- holc_count_white %>% inner_join(holc_count_black, by=c("holc_grade"))

holc_grades_ten <-holc_grades_ten%>%inner_join(holc_count_asian, by=c("holc_grade"))

holc_grades_ten <-holc_grades_ten%>%inner_join(holc_count_hispanic, by=c("holc_grade"))

holc_grades_pct <-holc_grades_ten%>%inner_join(holc_grades_pct, by=c("holc_grade"))


#holc grades with pct >5 per race

holc_count_black <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_black > 5) %>% 
  summarise(
    five_pct_black_neighborhoods_count = n()
  )

holc_count_hispanic  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_hisp > 5) %>% 
  summarise(
    five_pct_hisp_neighborhoods_count = n()
  )

holc_count_asian  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_asian > 5) %>% 
  summarise(
    five_pct_asian_neighborhoods_count = n()
  )

holc_count_white  <- metro_grades %>% 
  group_by(holc_grade) %>% 
  filter(pct_white > 5) %>% 
  summarise(
    five_pct_white_neighborhoods_count = n()
  )

holc_grades_five <- holc_count_white %>% inner_join(holc_count_black, by=c("holc_grade"))

holc_grades_five <-holc_grades_five%>%inner_join(holc_count_asian, by=c("holc_grade"))

holc_grades_five <-holc_grades_five%>%inner_join(holc_count_hispanic, by=c("holc_grade"))

holc_grades_pct <-holc_grades_five%>%inner_join(holc_grades_pct, by=c("holc_grade"))


```

```{r}
holc_three <-metro_grades%>%
  group_by(holc_grade)%>%
  filter(pct_asian >3, pct_black > 3, pct_white>3, pct_hisp>3)%>%
  summarise(
    neighborhoods_greater_than_three_pct_each_race=n()
  )


holc_four <-metro_grades%>%
  group_by(holc_grade)%>%
  filter(pct_asian >4, pct_black > 4, pct_white>4, pct_hisp>4)%>%
  summarise(
    neighborhoods_greater_than_four_pct_each_race=n()
  )

holc_five <-metro_grades%>%
  group_by(holc_grade)%>%
  filter(pct_asian >5, pct_black > 5, pct_white>5, pct_hisp>5)%>%
  summarise(
    neighborhoods_greater_than_five_pct_each_race=n()
  )

holc_six<-metro_grades%>%
  group_by(holc_grade)%>%
  filter(pct_asian >6, pct_black > 6, pct_white>6, pct_hisp>6)%>%
  summarise(
    neighborhoods_greater_than_six_pct_each_race=n()
  )

holc_diverse_neighborhoods <- holc_three %>% inner_join(holc_four, by=c("holc_grade"))

holc_diverse_neighborhoods <- holc_diverse_neighborhoods %>% inner_join(holc_five, by=c("holc_grade"))

holc_diverse_neighborhoods <- holc_diverse_neighborhoods %>% inner_join(holc_six, by=c("holc_grade"))



```


### Sentence 4

* **Sentence text**: [Paste in sentence to engineer here]
* **Analysis summary**: This code does pretty much the same thing as the code that looks at the racial breakdown of HOLC grades, but it also groups by state. When arranging the results by the white percent, we found that

```{r}
# Put code to reverse engineer sentence here

holc_grades_race_state <- metro_grades_plus_state %>% 
  group_by(holc_grade, state) %>% 
  summarise(
    pct_white = mean(pct_white),
    pct_black = mean(pct_black),
    pct_hisp = mean(pct_hisp),
    pct_asian = mean(pct_asian),
    pct_other = mean(pct_other))

# Display results of code below this codeblock

```

### Sentence 5

* **Sentence text**: [Paste in sentence to engineer here]
* **Analysis summary**: [Write up two to three sentences describing the results of your analysis.  Were you able to confirm the finding? If not, why not?]

```{r}

metro_grades_w_region <- metro_grades_plus_state %>% 
  mutate(
    region = case_when(
      (state %in% c("CA", "OR", "WA", "AK", "HI")) == TRUE ~ "Pacific West",
      (state %in% c("ID", "MT", "WY", "NV", "UT", "CO", "AZ", "NM")) == TRUE ~ "Mountain West",
      (state %in% c("TX", "OK", "AR", "LA")) == TRUE ~ "West South Central",
      (state %in% c("ND", "SD", "NE", "KS", "MN", "IA", "MO")) == TRUE ~ "West North Central",
      (state %in% c("WI", "IL", "IN", "MI", "OH")) == TRUE ~ "East North Central",
      (state %in% c("KY", "TN", "MS", "AL")) == TRUE ~ "East Soutch Central",
      (state %in% c("DE", "DC", "FL", "GA", "SC", "NC", "WV", "VA", "MD")) == TRUE ~ "South Atlantic",
      (state %in% c("CT", "ME", "MA", "VT", "NH", "RI")) == TRUE ~ "New England",
      (state %in% c("NJ", "NY", "PA")) == TRUE ~ "Middle Atlantic"
      
    )
  )
```


```{r}
holc_grades_race_region <- metro_grades_w_region %>% 
  group_by(holc_grade, region) %>% 
  summarise(
    pct_white = mean(pct_white),
    pct_black = mean(pct_black),
    pct_hisp = mean(pct_hisp),
    pct_asian = mean(pct_asian),
    pct_other = mean(pct_other))
```


-30-
